<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Calculadora Simplex Mejorada (Paso a Paso)</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f4f7f8; padding: 20px; color: #333; }
    .container { max-width: 900px; margin: auto; background: #fff; padding: 30px; border-radius: 8px; box-shadow: 0 0 15px rgba(0,0,0,0.1); }
    h2 { text-align: center; color: #007bff; }
    label { font-weight: bold; margin-top: 20px; display: block; }
    input, textarea, button { width: 100%; font-size: 16px; margin-top: 10px; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box; }
    button { background: #007bff; color: white; margin-top: 20px; border: none; }
    button:hover { background: #0056b3; }
    pre { background: #eef; padding: 15px; border-left: 5px solid #007bff; font-size: 15px; white-space: pre-wrap; margin-top: 20px; }
  </style>
</head>
<body>
<div class="container">
  <h2>Calculadora del Método Simplex (Paso a Paso)</h2>

  <label for="objetivo">Función objetivo (ej: max Z = 3x + 5y):</label>
  <input id="objetivo" placeholder="max Z = 3x + 5y" />

  <label for="restricciones">Restricciones (una por línea, ej: 2x + 3y <= 60):</label>
  <textarea id="restricciones" rows="6" placeholder="Ej:\n2x + y <= 18\n2x + 3y <= 42\n3x + y <= 24"></textarea>

  <button onclick="resolverSimplexPasoAPaso()">Resolver por Método Simplex</button>

  <label>Resultado y Proceso Paso a Paso:</label>
  <pre id="resultado">Esperando datos...</pre>
  <div id="grafico" style="margin-top: 40px;"></div>
</div>

<script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
function extraerVariables(texto) {
  const vars = new Set((texto.match(/[a-z]/gi) || []).map(v => v.toLowerCase()));
  vars.delete('z');
  return Array.from(vars).sort();
}

function parseExpr(expr, variables) {
  const vars = {};
  const terms = expr.match(/[+-]?\s*\d*\.?\d*\s*[a-z]/gi);
  if (terms) {
    for (let term of terms) {
      const match = term.match(/([+-]?\s*\d*\.?\d*)\s*([a-z])/i);
      if (!match) continue;
      let coef = match[1].replace(/\s/g, '');
      coef = coef === '' || coef === '+' ? 1 : coef === '-' ? -1 : parseFloat(coef);
      vars[match[2].toLowerCase()] = coef;
    }
  }
  return variables.map(v => vars[v] || 0);
}

function formatearTabla(matrix, headers) {
  const headerRow = headers.map(h => h.padStart(6)).join(' ');
  const rows = matrix.map(row => row.map(v => v.toFixed(2).padStart(6)).join(' '));
  return [headerRow, ...rows].join('\n');
}

function graficarRestricciones(A, b, variables, tableau) {
  const grafico = document.getElementById('grafico');
  const traces = [];

  for (let i = 0; i < A.length; i++) {
    const a = A[i][0] || 0;
    const b1 = A[i][1] || 0;
    const rhs = b[i];
    const x = [0, rhs / (a !== 0 ? a : 1)];
    const y = x.map(val => (rhs - a * val) / (b1 !== 0 ? b1 : 1));
    traces.push({ x, y, mode: 'lines', name: `Restricción ${i + 1}` });
  }

  const solX = tableau.find(r => r[1] === 1)?.[tableau[0].length - 1] || 0;
  const solY = tableau.find(r => r[2] === 1)?.[tableau[0].length - 1] || 0;

  traces.push({
    x: [solX],
    y: [solY],
    mode: 'markers+text',
    text: ['Óptimo'],
    textposition: 'top center',
    marker: { size: 10, color: 'red', symbol: 'star' },
    name: 'Solución Óptima'
  });

  Plotly.newPlot(grafico, traces, {
    title: 'Gráfico del Método Simplex',
    xaxis: { title: 'x', range: [0, 50] },
    yaxis: { title: 'y', range: [0, 50] },
    margin: { t: 40 }
  });
}

function resolverSimplexPasoAPaso() {
  const objText = document.getElementById('objetivo').value.toLowerCase();
  const resLines = document.getElementById('restricciones').value.trim().split('\n');
  const resultado = document.getElementById('resultado');

  if (!objText.includes('max')) {
    resultado.textContent = 'Solo se admite "max" en esta versión paso a paso.';
    return;
  }

  const variables = extraerVariables(objText + '\n' + resLines.join('\n'));
  if (variables.length === 0) {
    resultado.textContent = 'No se encontraron variables válidas.';
    return;
  }

  const numVars = variables.length;
  const numRes = resLines.length;
  const c = parseExpr(objText, variables);
  if (c.some(isNaN)) {
    resultado.textContent = 'Error al interpretar la función objetivo.';
    return;
  }

  const A = [], b = [];
  for (let line of resLines) {
    const parts = line.match(/(.+)(<=|>=|=)(.+)/);
    if (!parts) {
      resultado.textContent = `Error en la restricción: "${line}".`;
      return;
    }
    const [left, sign, right] = parts.slice(1).map(s => s.trim());
    const row = parseExpr(left, variables);
    if (row.some(isNaN) || isNaN(parseFloat(right))) {
      resultado.textContent = `Restricción inválida: "${line}".`;
      return;
    }
    A.push(row);
    b.push(parseFloat(right));
  }

  const tableau = A.map((row, i) => {
    const slack = Array(numRes).fill(0);
    slack[i] = 1;
    return [0, ...row, ...slack, b[i]];
  });
  const zRow = [1, ...c.map(v => -v), ...Array(numRes).fill(0), 0];
  tableau.push(zRow);

  const varNames = ['Z', ...variables, ...Array.from({ length: numRes }, (_, i) => `s${i + 1}`), 'RHS'];
  const baseVars = Array.from({ length: numRes }, (_, i) => `s${i + 1}`);
  let pasos = ['1. Tabla inicial con variables de holgura:', formatearTabla(tableau, varNames)];
  let iter = 0;

  while (true) {
    const lastRow = tableau.length - 1;
    const costRow = tableau[lastRow].slice(1, -1);
    const pivotCol = costRow.indexOf(Math.min(...costRow));
    if (tableau[lastRow][pivotCol + 1] >= 0) break;

    const ratios = tableau.slice(0, -1).map(row => {
      const val = row[pivotCol + 1];
      return val > 0 ? row[row.length - 1] / val : Infinity;
    });
    const pivotRow = ratios.indexOf(Math.min(...ratios));
    if (pivotRow === -1) {
      pasos.push('No hay solución factible.');
      break;
    }

    const entering = varNames[pivotCol + 1];
    const leaving = baseVars[pivotRow];
    baseVars[pivotRow] = entering;
    pasos.push(`\nIteración ${++iter}: entra ${entering}, sale ${leaving}`);

    const pivotVal = tableau[pivotRow][pivotCol + 1];
    tableau[pivotRow] = tableau[pivotRow].map(v => v / pivotVal);
    pasos.push(`Dividimos fila ${pivotRow + 1} entre ${pivotVal.toFixed(2)}.`);

    for (let i = 0; i < tableau.length; i++) {
      if (i !== pivotRow) {
        const factor = tableau[i][pivotCol + 1];
        const rowCopy = [...tableau[pivotRow]];
        tableau[i] = tableau[i].map((v, j) => v - factor * rowCopy[j]);
        pasos.push(`Restamos ${factor.toFixed(2)} × fila ${pivotRow + 1} a fila ${i + 1}`);
      }
    }
    pasos.push(formatearTabla(tableau, varNames));
  }

  const zOpt = tableau[tableau.length - 1][tableau[0].length - 1];
  pasos.push(`\nSolución óptima: Z = ${zOpt.toFixed(2)}`);
  for (let i = 0; i < numRes; i++) {
    pasos.push(`${baseVars[i]} = ${tableau[i][tableau[0].length - 1].toFixed(2)}`);
  }
  for (let v of variables) {
    if (!baseVars.includes(v)) pasos.push(`${v} = 0.00`);
  }
  resultado.textContent = pasos.join('\n');
  graficarRestricciones(A, b, variables, tableau);
}
</script>
</body>
</html>
