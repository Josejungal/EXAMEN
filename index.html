<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Calculadora Simplex Mejorada</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.11.0/math.min.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f4f7f8;
      padding: 20px;
      color: #333;
    }
    .container {
      max-width: 900px;
      margin: auto;
      background: #fff;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    h2 {
      text-align: center;
      color: #007bff;
    }
    label {
      font-weight: bold;
      margin-top: 20px;
      display: block;
    }
    input, textarea, button {
      width: 100%;
      font-size: 16px;
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      background: #007bff;
      color: white;
      margin-top: 20px;
      border: none;
    }
    button:hover {
      background: #0056b3;
    }
    pre {
      background: #eef;
      padding: 15px;
      border-left: 5px solid #007bff;
      font-size: 15px;
      white-space: pre-wrap;
      margin-top: 20px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Calculadora del Método Simplex</h2>

    <label for="objetivo">Función objetivo (ej: max Z = 3x1 + 5x2):</label>
    <input id="objetivo" placeholder="max Z = 3x1 + 5x2" />

    <label for="restricciones">Restricciones (una por línea, ej: 2x1 + 3x2 <= 60):</label>
    <textarea id="restricciones" rows="6" placeholder="Ej:\n2x1 + x2 <= 18\n2x1 + 3x2 <= 42\n3x1 + x2 <= 24"></textarea>

    <button onclick="resolverSimplex()">Resolver por Método Simplex</button>

    <label>Resultado:</label>
    <pre id="resultado">Esperando datos...</pre>

    <label>Iteraciones:</label>
    <pre id="iteraciones">---</pre>

    <div id="grafico" style="margin-top: 40px;"></div>
  </div>

  <script>
    function parseExpr(expr) {
      const terms = expr.match(/[+-]?\\s*\\d*\\.?\\d*\\s*x\\d+/g);
      const values = [];
      if (terms) {
        for (let term of terms) {
          const match = term.match(/([+-]?\\s*\\d*\\.?\\d*)\\s*x(\\d+)/);
          let coef = match[1].replace(/\\s/g, '');
          coef = coef === '' || coef === '+' ? 1 : coef === '-' ? -1 : parseFloat(coef);
          let index = parseInt(match[2]) - 1;
          values[index] = coef;
        }
      }
      return values;
    }

    function resolverSimplex() {
      const objInput = document.getElementById('objetivo').value.toLowerCase();
      const resInput = document.getElementById('restricciones').value.trim().split('\\n');
      const resultado = document.getElementById('resultado');
      const iteracionesOut = document.getElementById('iteraciones');

      let max = objInput.includes('max');
      let obj = parseExpr(objInput);
      let numVars = obj.length;

      let constraints = [];
      let b = [];
      let signs = [];

      for (let linea of resInput) {
        const partes = linea.match(/(.+)(<=|>=|=)(.+)/);
        if (!partes) {
          resultado.textContent = 'Error en una restricción.';
          return;
        }
        let [izq, signo, der] = partes.slice(1).map(s => s.trim());
        constraints.push(parseExpr(izq));
        b.push(parseFloat(der));
        signs.push(signo);
      }

      for (let i = 0; i < constraints.length; i++) {
        for (let j = 0; j < numVars; j++) {
          if (typeof constraints[i][j] === 'undefined') constraints[i][j] = 0;
        }
      }

      let tableau = constraints.map((fila, i) => {
        let slack = Array(constraints.length).fill(0);
        if (signs[i] === '<=') slack[i] = 1;
        else if (signs[i] === '>=') slack[i] = -1;
        return [...fila, ...slack, b[i]];
      });

      let Z = [...obj, ...Array(constraints.length).fill(0), 0];
      if (!max) Z = Z.map(v => -v);
      tableau.push(Z);

      let logs = [];
      let iteraciones = 0;
      while (tableau[tableau.length - 1].slice(0, -1).some(v => v < 0) && iteraciones++ < 50) {
        logs.push(`Iteración ${iteraciones}:\n` + tableau.map(f => f.map(v => v.toFixed(2)).join(' | ')).join('\\n'));
        tableau = pivot(tableau);
      }

      const Zopt = tableau[tableau.length - 1][tableau[0].length - 1];
      const vars = tableau[0].length - 1;
      const resultados = Array(numVars).fill(0);
      for (let j = 0; j < numVars; j++) {
        let columna = tableau.map(f => f[j]);
        if (columna.filter(x => x === 0).length === columna.length - 1 && columna.includes(1)) {
          let fila = columna.indexOf(1);
          resultados[j] = tableau[fila][vars];
        }
      }

      resultado.textContent = `Z óptimo = ${Zopt.toFixed(2)}\\n\\nVariables básicas:\\n` +
        resultados.map((v, i) => `x${i + 1} = ${v.toFixed(2)}`).join('\\n');

      iteracionesOut.textContent = logs.join('\\n\\n');

      if (numVars === 2) graficar(constraints, b, obj, signs, resultados, Zopt);
    }

    function pivot(t) {
      const last = t.length - 1;
      const pivotCol = t[last].slice(0, -1).reduce((min, val, i, arr) => val < arr[min] ? i : min, 0);
      if (t[last][pivotCol] >= 0) return t;

      let ratios = t.slice(0, last).map(row => {
        let val = row[pivotCol];
        return val > 0 ? row[row.length - 1] / val : Infinity;
      });

      let pivotRow = ratios.indexOf(Math.min(...ratios));
      if (pivotRow === -1 || ratios[pivotRow] === Infinity) return t;

      const pivotVal = t[pivotRow][pivotCol];
      t[pivotRow] = t[pivotRow].map(v => v / pivotVal);
      for (let i = 0; i <= last; i++) {
        if (i !== pivotRow) {
          let factor = t[i][pivotCol];
          t[i] = t[i].map((v, j) => v - factor * t[pivotRow][j]);
        }
      }
      return t;
    }

    function graficar(constraints, b, obj, signs, resultados, z) {
      const grafico = document.getElementById('grafico');
      const traces = [];

      for (let i = 0; i < constraints.length; i++) {
        const [a, b1] = constraints[i];
        const rhs = b[i];
        const x = [0, 50];
        const y = x.map(val => (rhs - a * val) / b1);
        traces.push({
          x,
          y,
          mode: 'lines',
          name: `Restricción ${i + 1}`
        });
      }

      const [c1, c2] = obj;
      const x = [0, 50];
      const y = x.map(val => (z - c1 * val) / c2);
      traces.push({
        x,
        y,
        mode: 'lines',
        name: 'Función Objetivo',
        line: { dash: 'dot', color: 'black' }
      });

      traces.push({
        x: [resultados[0]],
        y: [resultados[1]],
        mode: 'markers+text',
        text: ['Óptimo'],
        textposition: 'top center',
        marker: { size: 10, color: 'red', symbol: 'star' },
        name: 'Solución Óptima'
      });

      Plotly.newPlot('grafico', traces, {
        title: 'Gráfico del Método Simplex',
        xaxis: { title: 'x1', range: [0, 50] },
        yaxis: { title: 'x2', range: [0, 50] },
        margin: { t: 40 }
      });
    }
  </script>
</body>
</html>
